<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
 <TITLE>cclient.c</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <script type="text/javascript">
  <!--
   function ZweiFrames(URL1,F1,URL2,F2)
   {
    parent.frames[F1].location.href=URL1;
    parent.frames[F2].location.href=URL2;
   }
  //-->
  </script>
</HEAD>
<BODY BGCOLOR="#ffffff" style="margin-left:25">
<HR>
<H3><CENTER>cclient.c</CENTER></H3><HR>
<PRE>
int socketFD = 0; /* int socketFD = 0 ; */
<A NAME="0"></A>int isConnected = 0; /* int isConnected = 0 ; */
char *myHandle = ((void *)0 ); /* char * myHandle = ( ( void * ) 0 ) ; */

<FONT color="#0000ff"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match0-0.html#0',2,'match0-top.html#0',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>unsigned int __bswap_32(unsigned int __bsx) /*  */{
return __builtin_bswap32(__bsx); /* return __builtin_bswap32(__bsx) */
}
__uint64_t __bswap_64(__uint64_t __bsx) /*  */{
return __builtin_bswap64(__bsx); /* return __builtin_bswap64(__bsx) */
}
int main(int argc, char *argv) /* int main ( int argc , char * argv [ ] ) { */{</B></FONT>
if (argc != 4) /* if (argc != 4) */ {
printf(&quot;usage: %s handle host-name port-number \n&quot;, argv[0]); /* printf ( &quot;usage: %s handle host-name port-number \n&quot; , argv [ 0 ] ) ; */
exit(1); /* exit ( 1 ) ; */
}
socketFD = tcpClientSetup(argv[2], argv[3]); /* socketFD = tcpClientSetup ( argv [ 2 ] , argv [ 3 ] ) ; */
myHandle = argv[1]; /* myHandle = argv [ 1 ] ; */
sendPacketConnection(socketFD); /* sendPacketConnection ( socketFD ) ; */
process(); /* process ( ) ; */
return 0; /* return 0 */
}
void sendPacketConnection(int socket) /* void sendPacketConnection ( int socket ) { */{
int hLen = strlen(myHandle); /* int hLen = strlen ( myHandle ) ; */
void *packet = makePacketHandle(1, hLen, myHandle); /* void * packet = makePacketHandle ( 1 , hLen , myHandle ) ; */
if (sendPacket(packet, socket)&lt;0) /* if (sendPacket(packet, socket)&lt;0) */ {
perror(&quot;Packet Connection&quot;); /* perror ( &quot;Packet Connection&quot; ) ; */
exit(1); /* exit ( 1 ) ; */
}
free(packet); /* free ( packet ) ; */
}
void sendPacketBroadCast(char *mssg, int socket) /* void sendPacketBroadCast ( char * mssg , int socket ) { */{
char *toSend; /* char * toSend ; */
void *packet; /* void * packet ; */
int hLen = strlen(myHandle); /* int hLen = strlen ( myHandle ) ; */
int maxMssgLen = 1000 - hLen - sizeof(header) - 1; /* int maxMssgLen = 1000 - hLen - sizeof ( header ) - 1 ; */
int mssgNum = (strlen(mssg) + 1 ) / maxMssgLen; /* int mssgNum = ( strlen ( mssg ) + 1 ) / maxMssgLen ; */
int consumed = 0; /* int consumed = 0 ; */
int theRest = ((strlen(mssg) + 1 ) % maxMssgLen ) + mssgNum; /* int theRest = ( ( strlen ( mssg ) + 1 ) % maxMssgLen ) + mssgNum ; */
toSend = malloc(maxMssgLen); /* toSend = malloc ( maxMssgLen ) ; */
while (mssgNum&gt;0) /* while (mssgNum&gt;0) */ {
memcpy(toSend, mssg + consumed, maxMssgLen - 1); /* memcpy ( toSend , mssg + consumed , maxMssgLen - 1 ) ; */
toSend[maxMssgLen - 1] = 0; /* toSend [ maxMssgLen - 1 ] = 0 ; */
consumed += maxMssgLen - 1; /* consumed += maxMssgLen - 1 ; */
packet = makePacketBroadcast(4, hLen, myHandle, toSend); /* packet = makePacketBroadcast ( 4 , hLen , myHandle , toSend ) ; */
if (sendPacket(packet, socket)&lt;0) /* if (sendPacket(packet, socket)&lt;0) */ {
perror(&quot;Packet Broadcast&quot;); /* perror ( &quot;Packet Broadcast&quot; ) ; */
exit(1); /* exit ( 1 ) ; */
}
free(packet); /* free ( packet ) ; */
mssgNum--; /* mssgNum -- ; */
}
free(toSend); /* free ( toSend ) ; */
toSend = malloc(theRest); /* toSend = malloc ( theRest ) ; */
memcpy(toSend, mssg + consumed, theRest); /* memcpy ( toSend , mssg + consumed , theRest ) ; */
packet = makePacketBroadcast(4, hLen, myHandle, toSend); /* packet = makePacketBroadcast ( 4 , hLen , myHandle , toSend ) ; */
if (sendPacket(packet, socket)&lt;0) /* if (sendPacket(packet, socket)&lt;0) */ {
perror(&quot;Packet Broadcast&quot;); /* perror ( &quot;Packet Broadcast&quot; ) ; */
exit(1); /* exit ( 1 ) ; */
}
free(packet); /* free ( packet ) ; */
free(toSend); /* free ( toSend ) ; */
}
void sendPacketMssg(char *mssg, char *dest, int socket) /* void sendPacketMssg ( char * mssg , char * dest , int socket ) { */{
char *toSend; /* char * toSend ; */
void *packet; /* void * packet ; */
int srcLen = strlen(myHandle); /* int srcLen = strlen ( myHandle ) ; */
int destLen = strlen(dest); /* int destLen = strlen ( dest ) ; */
int maxMssgLen = 1000 - (srcLen + 1 ) - (destLen + 1 ) - sizeof(header); /* int maxMssgLen = 1000 - ( srcLen + 1 ) - ( destLen + 1 ) - sizeof ( header ) ; */
int mssgNum = (strlen(mssg) + 1 ) / maxMssgLen; /* int mssgNum = ( strlen ( mssg ) + 1 ) / maxMssgLen ; */
int consumed = 0; /* int consumed = 0 ; */
int theRest = ((strlen(mssg) + 1 ) % maxMssgLen ) + mssgNum; /* int theRest = ( ( strlen ( mssg ) + 1 ) % maxMssgLen ) + mssgNum ; */
toSend = malloc(maxMssgLen); /* toSend = malloc ( maxMssgLen ) ; */
while (mssgNum&gt;0) /* while (mssgNum&gt;0) */ {
memcpy(toSend, mssg + consumed, maxMssgLen - 1); /* memcpy ( toSend , mssg + consumed , maxMssgLen - 1 ) ; */
toSend[maxMssgLen - 1] = 0; /* toSend [ maxMssgLen - 1 ] = 0 ; */
consumed += maxMssgLen - 1; /* consumed += maxMssgLen - 1 ; */
packet = makePacketMssg(5, destLen, dest, srcLen, myHandle, toSend); /* packet = makePacketMssg ( 5 , destLen , dest , srcLen , myHandle , toSend ) ; */
if (sendPacket(packet, socket)&lt;0) /* if (sendPacket(packet, socket)&lt;0) */ {
perror(&quot;Packet Message&quot;); /* perror ( &quot;Packet Message&quot; ) ; */
exit(1); /* exit ( 1 ) ; */
}
free(packet); /* free ( packet ) ; */
mssgNum--; /* mssgNum -- ; */
}
free(toSend); /* free ( toSend ) ; */
toSend = malloc(theRest); /* toSend = malloc ( theRest ) ; */
memcpy(toSend, mssg + consumed, theRest); /* memcpy ( toSend , mssg + consumed , theRest ) ; */
packet = makePacketMssg(5, destLen, dest, srcLen, myHandle, toSend); /* packet = makePacketMssg ( 5 , destLen , dest , srcLen , myHandle , toSend ) ; */
if (sendPacket(packet, socket)&lt;0) /* if (sendPacket(packet, socket)&lt;0) */ {
perror(&quot;Packet Message&quot;); /* perror ( &quot;Packet Message&quot; ) ; */
exit(1); /* exit ( 1 ) ; */
}
free(packet); /* free ( packet ) ; */
free(toSend); /* free ( toSend ) ; */
}
int getFDForInput() /* int getFDForInput ( ) { */{
fd_set fdvar; /* fd_set fdvar ; */
int maxFD = socketFD + 1; /* int maxFD = socketFD + 1 ; */
FD_ZERO(&amp;fdvar); /* FD_ZERO ( &amp; fdvar ) ; */
FD_SET(socketFD, &amp;fdvar); /* FD_SET ( socketFD , &amp; fdvar ) ; */
if (isConnected) /* if (isConnected) */ {
FD_SET(fileno(stdin), &amp;fdvar); /* FD_SET ( fileno ( stdin ) , &amp; fdvar ) ; */
}
if (mySelect(maxFD, (fd_set *)&amp;fdvar, ((void *)0 ), ((void *)0 ), ((void *)0 )) == -1) /* if (mySelect(maxFD, (fd_set *)&amp;fdvar, ((void *)0 ), ((void *)0 ), ((void *)0 )) == -1) */ {
perror(&quot;Error selecting FD to read from&quot;); /* perror ( &quot;Error selecting FD to read from&quot; ) ; */
exit(1); /* exit ( 1 ) ; */
}
if (FD_ISSET(socketFD, &amp;fdvar)) /* if (FD_ISSET(socketFD, &amp;fdvar)) */ {
return socketFD; /* return socketFD */
}
if (isConnected&amp;&amp;FD_ISSET(fileno(stdin), &amp;fdvar)) /* if (isConnected&amp;&amp;FD_ISSET(fileno(stdin), &amp;fdvar)) */ {
<A NAME="1"></A>return fileno(stdin); /* return fileno(stdin) */
}
return -1; /* return -1 */
<FONT color="#f63526"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match0-0.html#1',2,'match0-top.html#1',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>}
void process() /* void process ( ) { */{
int fdToProcess; /* int fdToProcess ; */
while (1) /* while (1) */ {
printf(&quot;$: &quot;); /* printf ( &quot;$: &quot; ) ; */
fflush(stdout); /* fflush ( stdout ) ; */
fdToProcess = getFDForInput(); /* fdToProcess = getFDForInput ( ) ; */
if (fdToProcess == fileno(stdin)) /* if (fdToProcess == fileno(stdin)) */ {
processInput(); /* processInput ( ) ; */
} else {
printf(&quot;\n&quot;); /* printf ( &quot;\n&quot; ) ; */
processPacket(); /* processPacket ( ) ; */
}
}
}
void processPacket() /* void processPacket ( ) { */{</B></FONT>
uint8_t *packet = malloc(1000); /* uint8_t * packet = malloc ( 1000 ) ; */
uint8_t *toFree = packet; /* uint8_t * toFree = packet ; */
int numBytes = 0; /* int numBytes = 0 ; */
if ((numBytes = myRecv(socketFD, packet, 1000, 0) )&lt;0) /* if ((numBytes = myRecv(socketFD, packet, 1000, 0) )&lt;0) */ {
perror(&quot;recv call&quot;); /* perror ( &quot;recv call&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
if (numBytes == 0) /* if (numBytes == 0) */ {
printf(&quot;Server terminated\n&quot;); /* printf ( &quot;Server terminated\n&quot; ) ; */
close(socketFD); /* close ( socketFD ) ; */
exit(1); /* exit ( 1 ) ; */
}
while (numBytes&gt;0) /* while (numBytes&gt;0) */ {
switch (((header *)packet )-&gt;flag) /* switch (((header *)packet )-&gt;flag) */ {
case 2: 
printf(&quot;Connected to server\n&quot;); /* printf ( &quot;Connected to server\n&quot; ) ; */
isConnected = 1; /* isConnected = 1 ; */
break;
case 3: 
printf(&quot;Handle already in use: %s\n&quot;, myHandle); /* printf ( &quot;Handle already in use: %s\n&quot; , myHandle ) ; */
exit(1); /* exit ( 1 ) ; */
break;
case 9: 
<A NAME="2"></A>printf(&quot;Goodbye!\n&quot;); /* printf ( &quot;Goodbye!\n&quot; ) ; */
exit(0); /* exit ( 0 ) ; */
break;
<FONT color="#77bfc7"><div style="position:absolute;left:0"><A HREF="javascript:ZweiFrames('match0-0.html#2',2,'match0-top.html#2',1)"><IMG SRC="back.gif" ALT="other" BORDER="0" ALIGN="left"></A></div><B>case 4: 
printBroadcast(packet); /* printBroadcast ( packet ) ; */
break;
case 7: 
printf(&quot;No such handle connected to the server\n&quot;); /* printf ( &quot;No such handle connected to the server\n&quot; ) ; */
break;
case 5: 
printMessage(packet); /* printMessage ( packet ) ; */
break;
case 12: 
printHandle(packet); /* printHandle ( packet ) ; */
break;
case 11: 
printf(&quot;Number of clients: %u\n&quot;, packetHandleAckGetNum((packetHandleAck *)packet)); /* printf ( &quot;Number of clients: %u\n&quot; , packetHandleAckGetNum ( ( packetHandleAck * ) packet ) ) ; */
break;
default: 
printf(&quot;unknown packet %d with size %d\n&quot;, ((header *)packet )-&gt;flag, numBytes); /* printf ( &quot;unknown packet %d with size %d\n&quot; , ( ( header * ) packet ) -&gt; flag , numBytes ) ; */
break;
}</B></FONT>
packet += headerGetLen((header *)packet) + sizeof(header); /* packet += headerGetLen ( ( header * ) packet ) + sizeof ( header ) ; */
numBytes -= headerGetLen((header *)packet) + sizeof(header); /* numBytes -= headerGetLen ( ( header * ) packet ) + sizeof ( header ) ; */
}
free(toFree); /* free ( toFree ) ; */
}
void processInput() /* void processInput ( ) { */{
int didWork = 0; /* int didWork = 0 ; */
unsigned long inputNum = -1; /* unsigned long inputNum = - 1 ; */
char *line = ((void *)0 ); /* char * line = ( ( void * ) 0 ) ; */
char *lineToFree = ((void *)0 ); /* char * lineToFree = ( ( void * ) 0 ) ; */
char *cmd = ((void *)0 ); /* char * cmd = ( ( void * ) 0 ) ; */
char *mssg = ((void *)0 ); /* char * mssg = ( ( void * ) 0 ) ; */
char *dst = ((void *)0 ); /* char * dst = ( ( void * ) 0 ) ; */
getline(&amp;line, (size_t *)&amp;inputNum, stdin); /* getline ( &amp; line , ( size_t * ) &amp; inputNum , stdin ) ; */
lineToFree = line; /* lineToFree = line ; */
cmd = strtok(line, &quot; \n\t&quot;); /* cmd = strtok ( line , &quot; \n\t&quot; ) ; */
if (cmd != ((void *)0 )) /* if (cmd != ((void *)0 )) */ {
if (strcmp(cmd, &quot;%E&quot;) == 0 || strcmp(cmd, &quot;%e&quot;) == 0) /* if (strcmp(cmd, &quot;%E&quot;) == 0 || strcmp(cmd, &quot;%e&quot;) == 0) */ {
sendPacketFlag(8, socketFD); /* sendPacketFlag ( 8 , socketFD ) ; */
didWork = 1; /* didWork = 1 ; */
}
if (strcmp(cmd, &quot;%B&quot;) == 0 || strcmp(cmd, &quot;%b&quot;) == 0) /* if (strcmp(cmd, &quot;%B&quot;) == 0 || strcmp(cmd, &quot;%b&quot;) == 0) */ {
mssg = strtok(((void *)0 ), &quot;\n&quot;); /* mssg = strtok ( ( ( void * ) 0 ) , &quot;\n&quot; ) ; */
if (mssg == ((void *)0 )) /* if (mssg == ((void *)0 )) */ {
printf(&quot;Invalid command\n&quot;); /* printf ( &quot;Invalid command\n&quot; ) ; */
} else {
sendPacketBroadCast(mssg, socketFD); /* sendPacketBroadCast ( mssg , socketFD ) ; */
}
didWork = 1; /* didWork = 1 ; */
}
if (strcmp(cmd, &quot;%M&quot;) == 0 || strcmp(cmd, &quot;%m&quot;) == 0) /* if (strcmp(cmd, &quot;%M&quot;) == 0 || strcmp(cmd, &quot;%m&quot;) == 0) */ {
dst = strtok(((void *)0 ), &quot; \n\t&quot;); /* dst = strtok ( ( ( void * ) 0 ) , &quot; \n\t&quot; ) ; */
if (dst == ((void *)0 )) /* if (dst == ((void *)0 )) */ {
printf(&quot;Invalid command\n&quot;); /* printf ( &quot;Invalid command\n&quot; ) ; */
} else {
mssg = strtok(((void *)0 ), &quot;\n&quot;); /* mssg = strtok ( ( ( void * ) 0 ) , &quot;\n&quot; ) ; */
if (mssg == ((void *)0 )) /* if (mssg == ((void *)0 )) */ {
printf(&quot;Invalid command\n&quot;); /* printf ( &quot;Invalid command\n&quot; ) ; */
} else {
sendPacketMssg(mssg, dst, socketFD); /* sendPacketMssg ( mssg , dst , socketFD ) ; */
}
}
didWork = 1; /* didWork = 1 ; */
}
if (strcmp(cmd, &quot;%L&quot;) == 0 || strcmp(cmd, &quot;%l&quot;) == 0) /* if (strcmp(cmd, &quot;%L&quot;) == 0 || strcmp(cmd, &quot;%l&quot;) == 0) */ {
sendPacketFlag(10, socketFD); /* sendPacketFlag ( 10 , socketFD ) ; */
didWork = 1; /* didWork = 1 ; */
}
}
free(lineToFree); /* free ( lineToFree ) ; */
if (didWork == 0) /* if (didWork == 0) */ {
printf(&quot;Invalid command\n&quot;); /* printf ( &quot;Invalid command\n&quot; ) ; */
}
}
void processHandles(int handleNum) /* void processHandles ( int handleNum ) { */{
int i = 0; /* int i = 0 ; */
isConnected = 0; /* isConnected = 0 ; */
for (i = 0; i&lt;handleNum; i++) {
getFDForInput(); /* getFDForInput ( ) ; */
processPacket(); /* processPacket ( ) ; */
}
isConnected = 1; /* isConnected = 1 ; */
}
void printBroadcast(void *packet) /* void printBroadcast ( void * packet ) { */{
char *sender = ((void *)0 ); /* char * sender = ( ( void * ) 0 ) ; */
char *mssg = ((void *)0 ); /* char * mssg = ( ( void * ) 0 ) ; */
getFirstHandle(packet, &amp;sender); /* getFirstHandle ( packet , &amp; sender ) ; */
getBroadCastMssg(packet, &amp;mssg); /* getBroadCastMssg ( packet , &amp; mssg ) ; */
printf(&quot;%s: %s\n&quot;, sender, mssg); /* printf ( &quot;%s: %s\n&quot; , sender , mssg ) ; */
free(mssg); /* free ( mssg ) ; */
free(sender); /* free ( sender ) ; */
}
void printMessage(void *packet) /* void printMessage ( void * packet ) { */{
char *sender = ((void *)0 ); /* char * sender = ( ( void * ) 0 ) ; */
char *mssg = ((void *)0 ); /* char * mssg = ( ( void * ) 0 ) ; */
getSrcHandle(packet, &amp;sender); /* getSrcHandle ( packet , &amp; sender ) ; */
getMssg(packet, &amp;mssg); /* getMssg ( packet , &amp; mssg ) ; */
printf(&quot;%s: %s\n&quot;, sender, mssg); /* printf ( &quot;%s: %s\n&quot; , sender , mssg ) ; */
free(mssg); /* free ( mssg ) ; */
free(sender); /* free ( sender ) ; */
}
void printHandle(void *packet) /* void printHandle ( void * packet ) { */{
char *handle = ((void *)0 ); /* char * handle = ( ( void * ) 0 ) ; */
getFirstHandle(packet, &amp;handle); /* getFirstHandle ( packet , &amp; handle ) ; */
printf(&quot;  -%s\n&quot;, handle); /* printf ( &quot;  -%s\n&quot; , handle ) ; */
free(handle); /* free ( handle ) ; */
}
</PRE>
</BODY>
</HTML>
