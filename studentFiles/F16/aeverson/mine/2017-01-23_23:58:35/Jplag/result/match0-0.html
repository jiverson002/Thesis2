<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
 <TITLE>server.c</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <script type="text/javascript">
  <!--
   function ZweiFrames(URL1,F1,URL2,F2)
   {
    parent.frames[F1].location.href=URL1;
    parent.frames[F2].location.href=URL2;
   }
  //-->
  </script>
</HEAD>
<BODY BGCOLOR="#ffffff">
<HR>
<H3><CENTER>server.c</CENTER></H3><HR>
<PRE>
<A NAME="0"></A>

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match0-1.html#0',3,'match0-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>unsigned int __bswap_32(unsigned int a) /*  */{
return __builtin_bswap32(a); /* return __builtin_bswap32(__bsx) */
}
__uint64_t __bswap_64(__uint64_t a) /*  */{
return __builtin_bswap64(a); /* return __builtin_bswap64(__bsx) */
}
void sendBadHandle(int a) /* void sendBadHandle ( int socket ) { */{</B></FONT>
handleErr b; /* handleErr data ; */
b.flag = 3; /* data . flag = 3 ; */
b.packetLen = htons(3); /* data . packetLen = htons ( 3 ) ; */
if (send(a, (void *)&amp;b, 3, 0)&lt;0) /* if (send(socket, (void *)&amp;data, 3, 0)&lt;0) */ {
perror(&quot;Send on Server&quot;); /* perror ( &quot;Send on Server&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
}
void sendHandleACK(int a) /* void sendHandleACK ( int socket ) { */{
handleACK b; /* handleACK data ; */
b.flag = 2; /* data . flag = 2 ; */
b.packetLen = htons(3); /* data . packetLen = htons ( 3 ) ; */
if (send(a, (void *)&amp;b, 3, 0)&lt;0) /* if (send(socket, (void *)&amp;data, 3, 0)&lt;0) */ {
perror(&quot;Send on Server&quot;); /* perror ( &quot;Send on Server&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
}
<A NAME="1"></A>void sendNumClientsPacket(int a, int32_t b) /* void sendNumClientsPacket ( int socket , int32_t numHandles ) { */{
char *c = malloc(7); /* char * data = malloc ( 7 ) ; */
int d = htons(7); /* int length = htons ( 7 ) ; */
<FONT color="#f63526"><A HREF="javascript:ZweiFrames('match0-1.html#1',3,'match0-top.html#1',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int e = 11; /* int flag = 11 ; */
int32_t f = htonl(b); /* int32_t num = htonl ( numHandles ) ; */
memcpy(c, &amp;d, 2); /* memcpy ( data , &amp; length , 2 ) ; */
memcpy(&amp;c[2], &amp;e, 1); /* memcpy ( &amp; data [ 2 ] , &amp; flag , 1 ) ; */
memcpy(&amp;c[3], &amp;f, 4); /* memcpy ( &amp; data [ 3 ] , &amp; num , 4 ) ; */
if (send(a, (void *)c, 7, 0)&lt;0) /* if (send(socket, (void *)data, 7, 0)&lt;0) */ {
perror(&quot;Sending number of clients&quot;); /* perror ( &quot;Sending number of clients&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
}
void sendHandle(int a, Handle *b) /* void sendHandle ( int socket , Handle * handle ) { */{
int c = 12; /* int flag = 12 ; */
char *d = malloc(4 + b-&gt;length); /* char * data = malloc ( 4 + handle -&gt; length ) ; */</B></FONT>
int e = htons(4 + b-&gt;length); /* int length = htons ( 4 + handle -&gt; length ) ; */
memcpy(d, &amp;e, 2); /* memcpy ( data , &amp; length , 2 ) ; */
memcpy(&amp;d[2], &amp;c, 1); /* memcpy ( &amp; data [ 2 ] , &amp; flag , 1 ) ; */
memcpy(&amp;d[3], &amp;e, 1); /* memcpy ( &amp; data [ 3 ] , &amp; length , 1 ) ; */
memcpy(&amp;d[4], b-&gt;name, b-&gt;length); /* memcpy ( &amp; data [ 4 ] , handle -&gt; name , handle -&gt; length ) ; */
if (send(a, (void *)d, 4 + b-&gt;length, 0)&lt;0) /* if (send(socket, (void *)data, 4 + handle-&gt;length, 0)&lt;0) */ {
perror(&quot;Sending handle data&quot;); /* perror ( &quot;Sending handle data&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
free(d); /* free ( data ) ; */
}
void sendHandlePackets(int a, int32_t b) /* void sendHandlePackets ( int socket , int32_t numHandles ) { */{
int c = 0; /* int ndx = 0 ; */
for (c = 0; c&lt;b; c++) {
Handle *d = getClientData(c); /* Handle * handle = getClientData ( ndx ) ; */
sendHandle(a, d); /* sendHandle ( socket , handle ) ; */
}
<A NAME="2"></A>}
void sendExitPacket(int a) /* void sendExitPacket ( int socket ) { */{
handleACK b; /* handleACK data ; */
<FONT color="#77bfc7"><A HREF="javascript:ZweiFrames('match0-1.html#2',3,'match0-top.html#2',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>b.flag = 9; /* data . flag = 9 ; */
b.packetLen = htons(3); /* data . packetLen = htons ( 3 ) ; */
if (send(a, (void *)&amp;b, 3, 0)&lt;0) /* if (send(socket, (void *)&amp;data, 3, 0)&lt;0) */ {
perror(&quot;Send Exit ACK&quot;); /* perror ( &quot;Send Exit ACK&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
}
<A NAME="3"></A>void sendBadDest(int a, cclient *b) /* void sendBadDest ( int socketNum , cclient * handle ) { */{
badDest *c = malloc(sizeof(badDest)); /* badDest * packet = malloc ( sizeof ( badDest ) ) ; */</B></FONT>
int d = 4 + b-&gt;len; /* int size = 4 + handle -&gt; len ; */
<FONT color="#6cc417"><A HREF="javascript:ZweiFrames('match0-1.html#3',3,'match0-top.html#3',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>unsigned char *e = malloc(d); /* unsigned char * data = malloc ( size ) ; */
c-&gt;head.packetLen = htons(d); /* packet -&gt; head . packetLen = htons ( size ) ; */
c-&gt;head.flag = 7; /* packet -&gt; head . flag = 7 ; */
c-&gt;handle = b; /* packet -&gt; handle = handle ; */
memcpy(e, &amp;c-&gt;head, 3); /* memcpy ( data , &amp; packet -&gt; head , 3 ) ; */
memcpy(&amp;e[3], &amp;c-&gt;handle-&gt;len, 1); /* memcpy ( &amp; data [ 3 ] , &amp; packet -&gt; handle -&gt; len , 1 ) ; */
memcpy(&amp;e[4], c-&gt;handle-&gt;name, c-&gt;handle-&gt;len); /* memcpy ( &amp; data [ 4 ] , packet -&gt; handle -&gt; name , packet -&gt; handle -&gt; len ) ; */
if (send(a, e, d, 0)&lt;0) /* if (send(socketNum, data, size, 0)&lt;0) */ {
perror(&quot;Send Bad Dest&quot;); /* perror ( &quot;Send Bad Dest&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
free(e); /* free ( data ) ; */
free(c); /* free ( packet ) ; */
}
void sendMessage(int a, char *b, int c) /* void sendMessage ( int socket , char * buffer , int length ) { */{</B></FONT>
unsigned char *d = malloc(c); /* unsigned char * data = malloc ( length ) ; */
memcpy(d, b, c); /* memcpy ( data , buffer , length ) ; */
if (send(a, d, c, 0)&lt;0) /* if (send(socket, data, length, 0)&lt;0) */ {
perror(&quot;Send Message&quot;); /* perror ( &quot;Send Message&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
free(d); /* free ( data ) ; */
}
void constructMessage(Handle *a, cclient *b, char *c, int d) /* void constructMessage ( Handle * destInfo , cclient * srcInfo , char * buffer , int length ) { */{
int e = d - 4; /* int remainingLen = length - 4 ; */
char *f = malloc(d + 1 + a-&gt;length); /* char * data = malloc ( length + 1 + destInfo -&gt; length ) ; */
c[2] = 5; /* buffer [ 2 ] = 5 ; */
memcpy(f, c, 3); /* memcpy ( data , buffer , 3 ) ; */
memcpy(&amp;f[3], &amp;a-&gt;length, 1); /* memcpy ( &amp; data [ 3 ] , &amp; destInfo -&gt; length , 1 ) ; */
memcpy(&amp;f[4], a-&gt;name, a-&gt;length); /* memcpy ( &amp; data [ 4 ] , destInfo -&gt; name , destInfo -&gt; length ) ; */
memcpy(&amp;f[4 + a-&gt;length], &amp;c[3], e); /* memcpy ( &amp; data [ 4 + destInfo -&gt; length ] , &amp; buffer [ 3 ] , remainingLen ) ; */
if (send(a-&gt;socket, f, d + 1 + a-&gt;length, 0)&lt;0) /* if (send(destInfo-&gt;socket, data, length + 1 + destInfo-&gt;length, 0)&lt;0) */ {
perror(&quot;Send Message (To all)&quot;); /* perror ( &quot;Send Message (To all)&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
free(f); /* free ( data ) ; */
}
void sendMessageToAll(char *a, int b, cclient *c) /* void sendMessageToAll ( char * buffer , int length , cclient * srcInfo ) { */{
int d = 0, e = getNumHandles(); /* int ndx = 0 , numHandles = getNumHandles ( ) ; */
for (d = 0; d&lt;e; d++) {
Handle *f = getClientData(d); /* Handle * destInfo = getClientData ( ndx ) ; */
if (strcmp(f-&gt;name, c-&gt;name)) /* if (strcmp(destInfo-&gt;name, srcInfo-&gt;name)) */ {
constructMessage(f, c, a, b); /* constructMessage ( destInfo , srcInfo , buffer , length ) ; */
}
}
}
void parseDetails(int a, char *b, int c, int d) /* void parseDetails ( int numBytes , char * buffer , int socket , int clientSocket ) { */{
cclient e; /* cclient srcInfo ; */
uint16_t f; /* uint16_t length ; */
uint8_t g; /* uint8_t flag ; */
int32_t h = 0; /* int32_t numHandles = 0 ; */
cclient i; /* cclient destInfo ; */
int j = 0; /* int destSocket = 0 ; */
memcpy(&amp;f, b, 2); /* memcpy ( &amp; length , buffer , 2 ) ; */
f = ntohs(f); /* length = ntohs ( length ) ; */
memcpy(&amp;g, &amp;b[2], 1); /* memcpy ( &amp; flag , &amp; buffer [ 2 ] , 1 ) ; */
switch (g) /* switch (flag) */ {
case 1: memcpy(&amp;e.len, &amp;b[3], 1); /* memcpy ( &amp; srcInfo . len , &amp; buffer [ 3 ] , 1 ) ; */
memcpy(e.name, &amp;b[4], e.len); /* memcpy ( srcInfo . name , &amp; buffer [ 4 ] , srcInfo . len ) ; */
free(e.name); /* free ( srcInfo . name ) ; */
e.name = malloc(e.len); /* srcInfo . name = malloc ( srcInfo . len ) ; */
if (findHandle(e.name)&gt;0) /* if (findHandle(srcInfo.name)&gt;0) */ {
sendBadHandle(d); /* sendBadHandle ( clientSocket ) ; */
} else {
addHandle(e.name, e.len, d); /* addHandle ( srcInfo . name , srcInfo . len , clientSocket ) ; */
sendHandleACK(d); /* sendHandleACK ( clientSocket ) ; */
}
break;
case 4: memcpy(&amp;e.len, &amp;b[3], 1); /* memcpy ( &amp; srcInfo . len , &amp; buffer [ 3 ] , 1 ) ; */
sendMessageToAll(b, f, &amp;e); /* sendMessageToAll ( buffer , length , &amp; srcInfo ) ; */
memcpy(e.name, &amp;b[4], e.len); /* memcpy ( srcInfo . name , &amp; buffer [ 4 ] , srcInfo . len ) ; */
e.name = malloc(e.len + 1); /* srcInfo . name = malloc ( srcInfo . len + 1 ) ; */
e.name[e.len] = '\0'; /* srcInfo . name [ srcInfo . len ] = '\0' ; */
break;
case 5: memcpy(&amp;i.len, &amp;b[3], 1); /* memcpy ( &amp; destInfo . len , &amp; buffer [ 3 ] , 1 ) ; */
memcpy(i.name, &amp;b[4], i.len); /* memcpy ( destInfo . name , &amp; buffer [ 4 ] , destInfo . len ) ; */
free(i.name); /* free ( destInfo . name ) ; */
i.name = malloc(i.len + 1); /* destInfo . name = malloc ( destInfo . len + 1 ) ; */
i.name[i.len] = '\0'; /* destInfo . name [ destInfo . len ] = '\0' ; */
if (findHandle(i.name) == 0) /* if (findHandle(destInfo.name) == 0) */ {
sendBadDest(d, &amp;i); /* sendBadDest ( clientSocket , &amp; destInfo ) ; */
} else {
j = getSocket(i.name); /* destSocket = getSocket ( destInfo . name ) ; */
if (j == -1) /* if (destSocket == -1) */ {
printf(&quot;Something went wrong in handleList!\n&quot;); /* printf ( &quot;Something went wrong in handleList!\n&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
sendMessage(j, b, f); /* sendMessage ( destSocket , buffer , length ) ; */
}
break;
case 8: sendExitPacket(d); /* sendExitPacket ( clientSocket ) ; */
break;
case 10: h = getNumHandles(); /* numHandles = getNumHandles ( ) ; */
sendHandlePackets(d, h); /* sendHandlePackets ( clientSocket , numHandles ) ; */
sendNumClientsPacket(d, h); /* sendNumClientsPacket ( clientSocket , numHandles ) ; */
break;
default: printf(&quot;Bad flag!\n&quot;); /* printf ( &quot;Bad flag!\n&quot; ) ; */
printf(&quot;Flag is: %d\n&quot;, g); /* printf ( &quot;Flag is: %d\n&quot; , flag ) ; */
break;
}
}
void startServerChat(int a) /* void startServerChat ( int socketNum ) { */{
int b = 0; /* int client_socket = 0 ; */
int c, d = 0; /* int ndx , numFds = 0 ; */
<A NAME="4"></A>fd_set e, f; /* fd_set useFds , saveFds ; */
FD_ZERO(&amp;f); /* FD_ZERO ( &amp; saveFds ) ; */
FD_SET(a, &amp;f); /* FD_SET ( socketNum , &amp; saveFds ) ; */
<FONT color="#151b8d"><A HREF="javascript:ZweiFrames('match0-1.html#4',3,'match0-top.html#4',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>while (1) /* while (1) */ {
e = f; /* useFds = saveFds ; */
if (select(1024, &amp;e, ((void *)0 ), ((void *)0 ), ((void *)0 ))&lt;0) /* if (select(1024, &amp;useFds, ((void *)0 ), ((void *)0 ), ((void *)0 ))&lt;0) */ {
perror(&quot;select&quot;); /* perror ( &quot;select&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
}
for (c = 0; c&lt;1024; c++) {
if (FD_ISSET(c, &amp;e)) /* if (FD_ISSET(ndx, &amp;useFds)) */ {
if (c == a) /* if (ndx == socketNum) */ {</B></FONT>
b = tcpAccept(a); /* client_socket = tcpAccept ( socketNum ) ; */
<A NAME="5"></A>FD_SET(b, &amp;f); /* FD_SET ( client_socket , &amp; saveFds ) ; */
} else {
char *g = malloc(1024); /* char * buffer = malloc ( 1024 ) ; */
<FONT color="#c8c2a7"><A HREF="javascript:ZweiFrames('match0-1.html#5',3,'match0-top.html#5',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>int h = read(c, g, 1024); /* int nbytes = read ( ndx , buffer , 1024 ) ; */
if (h&lt;0) /* if (nbytes&lt;0) */ {
perror(&quot;read&quot;); /* perror ( &quot;read&quot; ) ; */
exit(-1); /* exit ( - 1 ) ; */
} else if (h == 0) /* if (nbytes == 0) */ {
((void)(((&amp;f )-&gt;__fds_bits )[((c ) / (8 * (int)sizeof(__fd_mask) ) )] &amp;= ~((__fd_mask )('U' &lt;&lt; ((c ) % (8 * (int)sizeof(__fd_mask) ) )) ) ) ); /* ( ( void ) ( ( ( &amp; saveFds ) -&gt; __fds_bits ) [ ( ( ndx ) / ( 8 * ( int ) sizeof ( __fd_mask ) ) ) ] &amp;= ~ ( ( __fd_mask ) ( 1UL &lt;&lt; ( ( ndx ) % ( 8 * ( int ) sizeof ( __fd_mask ) ) ) ) ) ) ) ; */
removeSocket(c); /* removeSocket ( ndx ) ; */
} else {
parseDetails(h, g, a, c); /* parseDetails ( nbytes , buffer , socketNum , ndx ) ; */
}
free(g); /* free ( buffer ) ; */
}</B></FONT>
}
}
}
close(b); /* close ( client_socket ) ; */
}
int main(int a, char *b) /* int main ( int argc , char * argv [ ] ) { */{
int c = 0; /* int server_socket = 0 ; */
int d = 0; /* int port_number = 0 ; */
if (a == 2) /* if (argc == 2) */ {
d = atoi(b[1]); /* port_number = atoi ( argv [ 1 ] ) ; */
}
c = tcpServerSetup(d); /* server_socket = tcpServerSetup ( port_number ) ; */
startServerChat(c); /* startServerChat ( server_socket ) ; */
close(c); /* close ( server_socket ) ; */
return 0; /* return 0 */
}
</PRE>
</BODY>
</HTML>
