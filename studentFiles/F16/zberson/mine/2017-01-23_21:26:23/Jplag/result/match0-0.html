<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
 <TITLE>packets.c</TITLE>
<META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <script type="text/javascript">
  <!--
   function ZweiFrames(URL1,F1,URL2,F2)
   {
    parent.frames[F1].location.href=URL1;
    parent.frames[F2].location.href=URL2;
   }
  //-->
  </script>
</HEAD>
<BODY BGCOLOR="#ffffff">
<HR>
<H3><CENTER>packets.c</CENTER></H3><HR>
<PRE>
<A NAME="0"></A>

<FONT color="#0000ff"><A HREF="javascript:ZweiFrames('match0-1.html#0',3,'match0-top.html#0',1)"><IMG SRC="forward.gif" ALT="other" BORDER="0" ALIGN="right"></A><B>unsigned int __bswap_32(unsigned int a) /* = * ( pos ) ; if ( raw -&gt; type */{
return __builtin_bswap32(a); /* return __builtin_bswap32(__bsx) */
}
__uint64_t __bswap_64(__uint64_t a) /* NULL6 || raw -&gt; type &gt; FLAG12 ) { */{
return __builtin_bswap64(a); /* return __builtin_bswap64(__bsx) */
}
void clear_raw_packet(raw_packet *a) /* static void clear_raw_packet ( raw_packet * packet ) { */{</B></FONT>
a-&gt;type = NULL0; /* packet -&gt; type = NULL0 ; */
a-&gt;packet_len = 0; /* packet -&gt; packet_len = 0 ; */
a-&gt;src_handle_len = 0; /* packet -&gt; src_handle_len = 0 ; */
a-&gt;src_handle_name = ((void *)0 ); /* packet -&gt; src_handle_name = ( ( void * ) 0 ) ; */
a-&gt;dest_handle_len = 0; /* packet -&gt; dest_handle_len = 0 ; */
a-&gt;dest_handle_name = ((void *)0 ); /* packet -&gt; dest_handle_name = ( ( void * ) 0 ) ; */
a-&gt;message = ((void *)0 ); /* packet -&gt; message = ( ( void * ) 0 ) ; */
a-&gt;to_be_sent = 0; /* packet -&gt; to_be_sent = 0 ; */
}
raw_packet * create_raw_packet() /* raw_packet * create_raw_packet ( ) { */{
raw_packet *a = calloc(1, sizeof(raw_packet)); /* raw_packet * raw = calloc ( 1 , sizeof ( raw_packet ) ) ; */
clear_raw_packet(a); /* clear_raw_packet ( raw ) ; */
return a; /* return raw */
}
rdy_packet * create_rdy_packet(uint16_t a) /* rdy_packet * create_rdy_packet ( uint16_t size ) { */{
rdy_packet *b = calloc(a, sizeof(char)); /* rdy_packet * rdy = calloc ( size , sizeof ( char ) ) ; */
return b; /* return rdy */
}
void destroy_raw_packet(raw_packet *a) /* void destroy_raw_packet ( raw_packet * packet ) { */{
if (a-&gt;src_handle_name) /* if (packet-&gt;src_handle_name) */ {
free(a-&gt;src_handle_name); /* free ( packet -&gt; src_handle_name ) ; */
a-&gt;src_handle_name = ((void *)0 ); /* packet -&gt; src_handle_name = ( ( void * ) 0 ) ; */
}
if (a-&gt;dest_handle_name) /* if (packet-&gt;dest_handle_name) */ {
free(a-&gt;dest_handle_name); /* free ( packet -&gt; dest_handle_name ) ; */
a-&gt;dest_handle_name = ((void *)0 ); /* packet -&gt; dest_handle_name = ( ( void * ) 0 ) ; */
}
if (a-&gt;message) /* if (packet-&gt;message) */ {
free(a-&gt;message); /* free ( packet -&gt; message ) ; */
a-&gt;message = ((void *)0 ); /* packet -&gt; message = ( ( void * ) 0 ) ; */
}
free(a); /* free ( packet ) ; */
}
void destroy_rdy_packet(rdy_packet *a) /* void destroy_rdy_packet ( rdy_packet * packet ) { */{
if (a) /* if (packet) */ {
free(a); /* free ( packet ) ; */
}
}
raw_packet * recycle_raw_packet(raw_packet *a) /* raw_packet * recycle_raw_packet ( raw_packet * packet ) { */{
destroy_raw_packet(a); /* destroy_raw_packet ( packet ) ; */
return create_raw_packet(); /* return create_raw_packet() */
}
rdy_packet * recycle_rdy_packet(rdy_packet *a, uint16_t b) /* rdy_packet * recycle_rdy_packet ( rdy_packet * packet , uint16_t size ) { */{
destroy_rdy_packet(a); /* destroy_rdy_packet ( packet ) ; */
return create_rdy_packet(b); /* return create_rdy_packet(size) */
}
void construct_packet_header(rdy_packet *a, raw_packet *b) /* static void construct_packet_header ( rdy_packet * rdy , raw_packet * raw ) { */{
uint8_t *c; /* uint8_t * pos ; */
if (b-&gt;type == FLAG12) /* if (raw-&gt;type == FLAG12) */ {
*(c ) = 0; /* * ( pos ) = 0 ; */
*(c + 1 ) = 0; /* * ( pos + 1 ) = 0 ; */
} else {
*((uint16_t *)c ) = htons(b-&gt;packet_len); /* * ( ( uint16_t * ) pos ) = htons ( raw -&gt; packet_len ) ; */
}
c = a + 2; /* pos = rdy + 0x02 ; */
*(c ) = b-&gt;type; /* * ( pos ) = raw -&gt; type ; */
}
int construct_packet(rdy_packet *a, raw_packet *b) /* int construct_packet ( rdy_packet * rdy , raw_packet * raw ) { */{
uint16_t c; /* uint16_t message_len ; */
uint8_t *d; /* uint8_t * pos ; */
if (b-&gt;type&lt;FLAG1 || b-&gt;type == NULL6 || b-&gt;type&gt;FLAG12) /* if (raw-&gt;type&lt;FLAG1 || raw-&gt;type == NULL6 || raw-&gt;type&gt;FLAG12) */ {
fprintf(stderr, &quot;Invalid flag type '%u'\n&quot;, b-&gt;type); /* fprintf ( stderr , &quot;Invalid flag type '%u'\n&quot; , raw -&gt; type ) ; */
return -1; /* return -1 */
}
construct_packet_header(a, b); /* construct_packet_header ( rdy , raw ) ; */
if (b-&gt;dest_handle_len) /* if (raw-&gt;dest_handle_len) */ {
*(d++ ) = b-&gt;dest_handle_len; /* * ( pos ++ ) = raw -&gt; dest_handle_len ; */
memcpy(d, b-&gt;dest_handle_name, b-&gt;dest_handle_len); /* memcpy ( pos , raw -&gt; dest_handle_name , raw -&gt; dest_handle_len ) ; */
}
if (b-&gt;src_handle_len) /* if (raw-&gt;src_handle_len) */ {
*(d++ ) = b-&gt;src_handle_len; /* * ( pos ++ ) = raw -&gt; src_handle_len ; */
memcpy(d, b-&gt;src_handle_name, b-&gt;src_handle_len); /* memcpy ( pos , raw -&gt; src_handle_name , raw -&gt; src_handle_len ) ; */
} else if (b-&gt;to_be_sent) /* if (raw-&gt;to_be_sent) */ {
*((uint32_t *)d ) = htonl(b-&gt;to_be_sent); /* * ( ( uint32_t * ) pos ) = htonl ( raw -&gt; to_be_sent ) ; */
}
if (b-&gt;type == FLAG4 || b-&gt;type == FLAG5) /* if (raw-&gt;type == FLAG4 || raw-&gt;type == FLAG5) */ {
c = b-&gt;packet_len - b-&gt;src_handle_len - b-&gt;dest_handle_len - b-&gt;type; /* message_len = raw -&gt; packet_len - raw -&gt; src_handle_len - raw -&gt; dest_handle_len - raw -&gt; type ; */
memcpy(d, b-&gt;message, c); /* memcpy ( pos , raw -&gt; message , message_len ) ; */
}
return 0; /* return 0 */
}
int deconstruct_packet(raw_packet *a, rdy_packet *b) /* int deconstruct_packet ( raw_packet * raw , rdy_packet * rdy ) { */{
uint16_t c; /* uint16_t message_len ; */
uint8_t *d; /* uint8_t * pos ; */
d = b + 2; /* pos = rdy + 0x02 ; */
a-&gt;type = *(d ); /* raw -&gt; type = * ( pos ) ; */
if (a-&gt;type&lt;FLAG1 || a-&gt;type == NULL6 || a-&gt;type&gt;FLAG12) /* if (raw-&gt;type&lt;FLAG1 || raw-&gt;type == NULL6 || raw-&gt;type&gt;FLAG12) */ {
fprintf(stderr, &quot;Invalid flag type '%u'\n&quot;, a-&gt;type); /* fprintf ( stderr , &quot;Invalid flag type '%u'\n&quot; , raw -&gt; type ) ; */
return -1; /* return -1 */
}
if (a-&gt;type == FLAG12) /* if (raw-&gt;type == FLAG12) */ {
d = b + 3; /* pos = rdy + 0x03 ; */
a-&gt;packet_len = *(d ) + 4; /* raw -&gt; packet_len = * ( pos ) + 0x04 ; */
} else {
d = b + 0; /* pos = rdy + 0x00 ; */
a-&gt;packet_len = ntohs(*((uint16_t *)d )); /* raw -&gt; packet_len = ntohs ( * ( ( uint16_t * ) pos ) ) ; */
}
d = b + 3; /* pos = rdy + 0x03 ; */
switch (a-&gt;type) /* switch (raw-&gt;type) */ {
case FLAG5: a-&gt;dest_handle_len = *(d++ ); /* raw -&gt; dest_handle_len = * ( pos ++ ) ; */
memcpy(a-&gt;dest_handle_name, d, a-&gt;dest_handle_len); /* memcpy ( raw -&gt; dest_handle_name , pos , raw -&gt; dest_handle_len ) ; */
d += a-&gt;dest_handle_len; /* pos += raw -&gt; dest_handle_len ; */
a-&gt;dest_handle_name = calloc(a-&gt;dest_handle_len + 1, sizeof(uint8_t)); /* raw -&gt; dest_handle_name = calloc ( raw -&gt; dest_handle_len + 1 , sizeof ( uint8_t ) ) ; */
case FLAG1: case FLAG4: case FLAG7: case FLAG12: a-&gt;src_handle_len = *(d++ ); /* raw -&gt; src_handle_len = * ( pos ++ ) ; */
memcpy(a-&gt;src_handle_name, d, a-&gt;src_handle_len); /* memcpy ( raw -&gt; src_handle_name , pos , raw -&gt; src_handle_len ) ; */
d += a-&gt;src_handle_len; /* pos += raw -&gt; src_handle_len ; */
a-&gt;src_handle_name = calloc(a-&gt;src_handle_len + 1, sizeof(uint8_t)); /* raw -&gt; src_handle_name = calloc ( raw -&gt; src_handle_len + 1 , sizeof ( uint8_t ) ) ; */
break;
default: break;
}
if (a-&gt;type == FLAG4 || a-&gt;type == FLAG5) /* if (raw-&gt;type == FLAG4 || raw-&gt;type == FLAG5) */ {
c = a-&gt;packet_len - a-&gt;src_handle_len - a-&gt;dest_handle_len - a-&gt;type; /* message_len = raw -&gt; packet_len - raw -&gt; src_handle_len - raw -&gt; dest_handle_len - raw -&gt; type ; */
a-&gt;message = calloc(c + 1, sizeof(uint8_t)); /* raw -&gt; message = calloc ( message_len + 1 , sizeof ( uint8_t ) ) ; */
memcpy(a-&gt;message, d, c); /* memcpy ( raw -&gt; message , pos , message_len ) ; */
} else if (a-&gt;type == FLAG11) /* if (raw-&gt;type == FLAG11) */ {
a-&gt;to_be_sent = ntohl(*((uint32_t *)d )); /* raw -&gt; to_be_sent = ntohl ( * ( ( uint32_t * ) pos ) ) ; */
}
return 0; /* return 0 */
}
</PRE>
</BODY>
</HTML>
